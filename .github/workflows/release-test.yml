name: Test Release Builds

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build Linux release
        run: cargo build --release

      - name: Package Linux binary
        run: |
          mkdir dist
          cp target/release/russian_roulette dist/
          VERSION=${{ github.ref_name }}
          tar -czvf russian_roulette-${VERSION}-x86_64-linux.tar.gz dist/*

      - name: Generate checksums
        run: |
          sha256sum russian_roulette-* > SHA256SUMS-linux.txt

      - name: Upload Linux checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums-linux
          path: SHA256SUMS-linux.txt

      - name: Upload Linux artifact
        uses: softprops/action-gh-release@v2
        with:
          files: russian_roulette-${{ github.ref_name }}-x86_64-linux.tar.gz

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Build Windows release
        run: cargo build --release

      - name: Package Windows binary
        run: |
          mkdir dist
          $VERSION = "${{ github.ref_name }}"
          copy target\release\russian_roulette.exe dist\
          powershell Compress-Archive dist russian_roulette-$VERSION-x86_64-windows.zip

      - name: Generate checksums
        run: |
            Get-FileHash russian_roulette-* -Algorithm SHA256 |
              ForEach-Object {
                "$($_.Hash)  $($_.Path)"
              } > SHA256SUMS-windows.txt

      - name: Upload Windows checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums-windows
          path: SHA256SUMS-windows.txt

      - name: Upload Windows artifact
        uses: softprops/action-gh-release@v2
        with:
          files: russian_roulette-${{ github.ref_name }}-x86_64-windows.zip

  macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build macOS release
        run: cargo build --release

      - name: Package macOS binary
        run: |
          mkdir dist
          cp target/release/russian_roulette dist/
          tar -czvf russian_roulette-${{ github.ref_name }}-macos-arm64.tar.gz dist/*

      - name: Generate checksums
        run: |
          shasum -a 256 russian_roulette-* > SHA256SUMS-macos.txt


      - name: Upload macOS checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums-macos
          path: SHA256SUMS-macos.txt

      - name: Upload macOS artifact
        uses: softprops/action-gh-release@v2
        with:
          files: russian_roulette-${{ github.ref_name }}-macos-arm64.tar.gz

  android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Add Android toolchain to PATH
        run: |
          echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH


      - name: Build Android release
        run: cargo build --release --target aarch64-linux-android

      - name: Package Android binary
        run: |
          mkdir dist
          cp target/aarch64-linux-android/release/russian_roulette dist/
          tar -czvf russian_roulette-${{ github.ref_name }}-aarch64-linux-android.tar.gz dist/*

      - name: Generate checksums
        run: |
          sha256sum russian_roulette-* > SHA256SUMS-android.txt


      - name: Upload Android checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums-android
          path: SHA256SUMS-android.txt

      - name: Upload Android artifact
        uses: softprops/action-gh-release@v2
        with:
          files: russian_roulette-${{ github.ref_name }}-aarch64-linux-android.tar.gz
